<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/main_layout}">

<th:block layout:fragment="css">

    <style>
        .modal-dialog {
            width: 70%;
            max-width: 50%;
        }

        .thumbnail {
            margin-bottom: 10px;
            width: 100%;
            max-width: 150px;
        }

        .content {
            margin-top: 60px;
        }

        .imgboard {
            height: 500px;
            overflow: auto;
        }

        span {
            height: 30px;
        }

        .img-box {
            text-align: center;
        }
    </style>

</th:block>

<div layout:fragment="content">
    <section class="content">
        <section class="container">
            <header class="text-center">
                <h2>이미지 갤러리</h2>
            </header>
            <input type="hidden" id="page" name="page" value="0">
            <section class="row imgboard" id="galleryCanvas">
                <div class="col-lg-3 col-md-4  col-sm-6  col-12">
                    <input type="checkbox">
                    <div class="img-box">
                        <img class="thumbnail img-responsive" src="/img/poobao.jpg">
                    </div>
                    <span style='font-size: 20px;'>
                        <a href="javascript:void(0)">푸바오</a>
                    </span>
                    <span>저자 | 2023-01-01</span>
                </div>
            </section>
            <section>
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center" id="pageArea"> </ul>
                </nav>
            </section>
            <section class="row" style="margin-top: 15px;">
                <div class="col-12" style="width: 100%;text-align: right;margin-right: 80px;">
                    <button type="button" class="btn btn-primary" onclick="openAddModal();">글 등록</button>
                    <button type="button" class="btn btn-danger" onclick="deleteSelected();">선택 삭제</button>
                </div>
            </section>
        </section>
    </section>

    <!-- 등록 모달 -->
    <div class="modal fade" tabindex="-1" id="addGallModal" aria-labelledby="addGallModalLabel" aria-hidden="false"
        data-bs-foucs="false">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addGallModalLabel">이미지 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addGallFrm">
                        <div class="row mb-3">
                            <div class="col-auto pt-1">
                                <label for="addTitle" class="col-form-label">제목 : </label>
                            </div>
                            <div class="col-9">
                                <input type="text" class="form-control" id="addTitle" name="title">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-auto pt-1">
                                <label class="col-form-label">파일 : </label>
                            </div>
                            <div class="col-9">
                                <input type="file" class="form-control" id="addFile" name="file">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveNewGallery();">저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 수정 모달 -->
    <div class="modal fade" tabindex="-1" id="updateGallModal" aria-labelledby="updateGallModalLabel"
        aria-hidden="false" data-bs-foucs="false">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateGallModalLabel">이미지 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateGallFrm">
                        <input type="hidden" id="updateNums" name="nums">
                        <div class="row mb-3">
                            <div class="col-auto pt-1">
                                <label for="updateTitle" class="col-form-label">제목 : </label>
                            </div>
                            <div class="col-9">
                                <input type="text" class="form-control" id="updateTitle" name="title">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-auto pt-1">
                                <label class="col-form-label">파일 : </label>
                            </div>
                            <div class="col-9">
                                <input type="file" class="form-control" id="updateFile" name="file">
                                <span id="currentFileName" class="form-text text-muted"></span>

                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveUpdatedGallery();">수정</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // 등록 모달 열기
        function openAddModal() {
            const addModal = $('#addGallModal');
            addModal.modal('show');
            addModal.on('hidden.bs.modal', () => {
                $('#addGallFrm')[0].reset();
            });
        }

        // 수정 모달을 데이터로 채워서 열기
        function openUpdateModal(data) {
            const updateModal = $('#updateGallModal');
            $('#updateNums').val(data.nums);
            $('#updateTitle').val(data.title);
            $('#currentFileName').text('현재 파일: ' + data.fileName);
            updateModal.modal('show');
            updateModal.on('hidden.bs.modal', () => {
                $('#updateGallFrm')[0].reset();
                $('#currentFileName').text(''); // 모달 닫을 때 파일명 초기화
            });
        }

        // 폼 유효성 검사
        function validated(type) {
            const title = $(`#${type}Title`);
            const file = $(`#${type}File`);

            if ($.trim(title.val()).length === 0) {
                alert('제목을 입력하십시오');
                title.focus();
                return false;
            }

            if (type === 'add' && file.val().length === 0) {
                alert('등록할 파일을 선택하십시오');
                return false;
            }

            if (type === 'update' && file.val().length > 0) {
                if (!confirm('기존 이미지를 변경하시겠습니까?')) {
                    return false;
                }
            }

            if (file.val().length > 0) {
                if (!file.val().match(/\.(jpg|jpeg|png|gif|webp|bmp)$/i)) {
                    alert('이미지만 업로드가 가능합니다.');
                    return false;
                }
                const maxSize = 1024 * 1024 * 50;
                if (file[0].files[0].size > maxSize) {
                    alert('파일 최대 크기는 50MB까지 가능합니다.');
                    return false;
                }
            }
            return true;
        }

        // 새 갤러리 저장
        async function saveNewGallery() {
            if (validated('add')) {
                const formData = new FormData($('#addGallFrm')[0]);
                try {
                    const resp = await axios.post('/api/v1/gal', formData, { headers: { 'Content-type': 'multipart/form-data' } });
                    if (resp.data.resultCode === 200) {
                        alert('이미지가 등록되었습니다.');
                        getData();
                    } else {
                        alert('이미지 등록이 실패했습니다.');
                    }
                    $('#addGallModal').modal('hide');
                } catch (error) {
                    alert(error);
                }
            }
        }

        // 갤러리 수정 저장
        async function saveUpdatedGallery() {
            if (validated('update')) {
                const formData = new FormData($('#updateGallFrm')[0]);
                try {
                    const resp = await axios.post('/api/v1/gal/update', formData, { headers: { 'Content-type': 'multipart/form-data' } });
                    if (resp.data.resultCode === 200) {
                        alert('이미지가 수정되었습니다.');
                        getData();
                    } else {
                        alert('이미지 수정이 실패했습니다.');
                    }
                    $('#updateGallModal').modal('hide');
                } catch (error) {
                    alert(error);
                }
            }
        }

        function getData() {
            const page = $('#page').val();
            axios.get('/api/v1/gal', { params: { page } })
                .then(res => {
                    drawGalleryPage(res.data);
                });
        }

        function drawGalleryPage(data) {
            const galleryCanvas = $('#galleryCanvas');
            const pageArea = $('#pageArea');
            galleryCanvas.empty();
            pageArea.empty();

            $.each(data.content, (index, obj) => {
                const html = makeGalleryBox(obj);
                galleryCanvas.append(html);
            });

            pageArea.append(data.pageHTML);
        }

        function makeGalleryBox(data) {
            const rootDiv = $('<div class="col-lg-3 col-md-4 col-sm-6 col-12"></div>');
            const checkBox = $(`<input type="checkbox" name="imgChk" value="${data.nums}">`);
            const imgBox = $('<div class="img-box"></div>');
            const img = $(`<img src="/static/imgs/thumb/${data.fileThumbName}" alt="${data.title}" class="thumbnail img-responsive">`);
            const titleSpan = $('<span style="font-size: 20px;"></span>');
            const dateSpan = $('<span></span>');
            // 제목 클릭 시 수정 모달 열기
            const link = $(`<a href="javascript:void(0)" onclick='openUpdateModal(${JSON.stringify(data)})'></a>`);

            link.text(data.title);
            dateSpan.text(' | ' + data.lastModifiedDate);
            imgBox.append(img);

            rootDiv.append(checkBox);
            rootDiv.append(imgBox);
            titleSpan.append(link);
            rootDiv.append(titleSpan);
            rootDiv.append(dateSpan);

            return rootDiv;
        }

        // 선택된 이미지 삭제 함수
        async function deleteSelected() {
            const checkedItems = $('input[name="imgChk"]:checked');

            if (checkedItems.length === 0) {
                alert('삭제할 이미지를 선택해주세요.');
                return;
            }

            if (confirm('선택한 이미지를 정말 삭제하시겠습니까?')) {
                const ids = [];
                checkedItems.each(function () {
                    ids.push($(this).val());
                });

                try {
                    const response = await axios.delete('/api/v1/gal', { data: ids });
                    if (response.status === 200) {
                        alert('선택한 이미지가 삭제되었습니다.');
                        getData();
                    }
                } catch (error) {
                    console.error(error);
                    alert('삭제 중 오류가 발생했습니다.');
                }
            }
        }

        $(document).ready(function () {
            getData();
        });
    </script>

</div>

</html>